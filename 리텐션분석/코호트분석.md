# 코호트 분석 sql 쿼리
1. order_date를 이용해 order_month 만들어주기
2. first_order_date열을 이용해서 first_order_month열을 만들어준다. --> first_order_month열을 추가한 테이블을 저장
3. first_order_month열을 groupby --> month0에 구매한 고객 열을 만들어주기
4. first_order 다음 month에도 구매 데이터가 있다면 month1로 저장


``` sql
WITH records_preprocessed AS (
SELECT 
  r.customer_id
  , r.order_date
  , c.first_order_date
  , DATE_FORMAT(r.order_date, '%Y-%m-01') order_month
  , DATE_FORMAT(c.first_order_date, '%Y-%m-01') AS first_order_month 
FROM records r
INNER JOIN customer_stats c ON r.customer_id = c.customer_id
)


SELECT first_order_month
    , COUNT(DISTINCT(customer_id)) month0
    , COUNT(DISTINCT(CASE WHEN 
            DATE_ADD(first_order_month, INTERVAL 1 MONTH) = order_month 
            THEN customer_id ELSE NULL END)) month1
FROM records_preprocessed
GROUP BY first_order_month
ORDER BY first_order_month
```

> output


|first_order_moth|month0|month1|
|--|--|--|
|2020-01-01|67|3|
|2020-02-01|50|6|
|2020-03-01|101|13|
