# 코호트 분석 sql 쿼리
1. order_date를 이용해 order_month 만들어주기
2. first_order_date열을 이용해서 first_order_month열을 만들어준다. --> first_order_month열을 추가한 테이블을 저장
3. first_order_month열을 groupby --> month0에 구매한 고객 열을 만들어주기
4. first_order 다음 month에도 구매 데이터가 있다면 month1로 저장


``` sql
WITH records_preprocessed AS (
SELECT 
  r.customer_id
  , r.order_date
  , c.first_order_date
  , DATE_FORMAT(r.order_date, '%Y-%m-01') order_month
  , DATE_FORMAT(c.first_order_date, '%Y-%m-01') AS first_order_month 
FROM records r
INNER JOIN customer_stats c ON r.customer_id = c.customer_id
)


SELECT first_order_month
    , COUNT(DISTINCT(customer_id)) month0
    , COUNT(DISTINCT(CASE WHEN 
            DATE_ADD(first_order_month, INTERVAL 1 MONTH) = order_month 
            THEN customer_id ELSE NULL END)) month1
FROM records_preprocessed
GROUP BY first_order_month
ORDER BY first_order_month


# 1년치 전부 다 열을 만들면..!
-- CASE WHEN THEN
-- IF 둘다 사용했음

SELECT first_order_month
    , COUNT(DISTINCT(customer_id)) month0
    , COUNT(DISTINCT(
            CASE
              WHEN DATE_ADD(first_order_month, INTERVAL 1 MONTH) = order_month THEN customer_id
              ELSE NULL
            END)) month1
    , COUNT(DISTINCT (IF(DATE_ADD(first_order_month, INTERVAL 2 MONTH) = order_month, customer_id, null ))) month2
    , COUNT(DISTINCT (IF(DATE_ADD(first_order_month, INTERVAL 3 MONTH) = order_month, customer_id, null ))) month3
    , COUNT(DISTINCT (IF(DATE_ADD(first_order_month, INTERVAL 4 MONTH) = order_month, customer_id, null ))) month4
    , COUNT(DISTINCT (IF(DATE_ADD(first_order_month, INTERVAL 5 MONTH) = order_month, customer_id, null ))) month5
    , COUNT(DISTINCT (IF(DATE_ADD(first_order_month, INTERVAL 6 MONTH) = order_month, customer_id, null ))) month6
    , COUNT(DISTINCT (IF(DATE_ADD(first_order_month, INTERVAL 7 MONTH) = order_month, customer_id, null ))) month7
    , COUNT(DISTINCT (IF(DATE_ADD(first_order_month, INTERVAL 8 MONTH) = order_month, customer_id, null ))) month8
    , COUNT(DISTINCT (IF(DATE_ADD(first_order_month, INTERVAL 9 MONTH) = order_month, customer_id, null ))) month9
    , COUNT(DISTINCT (IF(DATE_ADD(first_order_month, INTERVAL 10 MONTH) = order_month, customer_id, null ))) month10
    , COUNT(DISTINCT (IF(DATE_ADD(first_order_month, INTERVAL 11 MONTH) = order_month, customer_id, null ))) month11
FROM records_preprocessed
GROUP BY first_order_month
ORDER BY first_order_month
```

> output


|first_order_moth|month0|month1|
|--|--|--|
|2020-01-01|67|3|
|2020-02-01|50|6|
|2020-03-01|101|13|
